(function(n,a){typeof exports=="object"&&typeof module!="undefined"?a(exports,require("nanoid")):typeof define=="function"&&define.amd?define(["exports","nanoid"],a):(n=typeof globalThis!="undefined"?globalThis:n||self,a(n["vue-validate-form"]={},n.nanoid))})(this,function(n,a){"use strict";const u=Symbol("hasFieldValue"),l=Symbol("getFieldValue"),f=Symbol("getFieldDefaultValue"),p=Symbol("getErrors"),h=Symbol("register"),y=Symbol("validate"),m=Symbol("getIsSubmitted");var b=Object.freeze(Object.defineProperty({__proto__:null,hasFieldValue:u,getFieldValue:l,getFieldDefaultValue:f,getErrors:p,register:h,validate:y,getIsSubmitted:m},Symbol.toStringTag,{value:"Module"}));function c(e,t=null){return e.$scopedSlots.default?e.$scopedSlots.default(t)||[]:e.$slots.default||[]}function v(e,t){if(!g(e))return!1;let i=t.split(".");for(;i.length;){const s=i.shift();if(!(s in e))return!1;e=e[s]}return!0}function o(e,t,i){if(!g(e))return i;let s=t.split(".");for(;s.length;){const r=s.shift();if(!(r in e))return i;e=e[r]}return e}function S(e,t,i){if(!g(e))return;let s=t.split(".");for(;s.length>1;){const r=s.shift();g(e[r])||(e[r]=N(s[0])?[]:{}),e=e[r]}e[s[0]]=i}function N(e){const t=Number(e);return!Number.isNaN(t)}function g(e){return!!e&&typeof e=="object"}const V="onFieldChange",F="onFormChange";var C={name:"ValidationProvider",provide(){return{[h]:this.register,[y]:this.handleValidate,[f]:this.getFieldDefaultValue,[l]:this.getValueByFieldName,[p]:this.getErrors,[u]:this.hasValueByFieldName,[m]:this.getIsSubmitted}},props:{defaultValues:{type:Object,default:()=>({})},defaultErrors:{type:Object,default:()=>({})},resolver:{type:Function,default:e=>({values:e,errors:{}})},tag:{type:String,default:"div"}},data(){return{submitted:!1,innerDefaultValues:{},fieldComponents:[],additionalErrors:{}}},computed:{fieldComponentMap(){return this.fieldComponents.reduce((e,t)=>(e[t.name]=t,e),{})},values(){return this.fieldComponents.reduce((e,{name:t,getValue:i})=>(S(e,t,i()),e),{})},dirty(){return this.fieldComponents.some(({dirty:e})=>e)},pristine(){return!this.fieldComponents.some(({pristine:e})=>!e)},errors(){return this.fieldComponents.reduce((e,{name:t,errors:i})=>(e[t]=i,e),Object.assign({},this.additionalErrors))},existsErrors(){return Object.values(this.errors).some(e=>e.length)},firstInvalidFieldComponent(){return this.fieldComponents.find(({name:e})=>this.errors[e].length)}},watch:{defaultValues:{immediate:!0,handler:"setDefaultData"},defaultErrors:"setDefaultData",dirty:{immediate:!0,handler(e){this.$emit("dirty",e)}}},methods:{async handleValidate(e){const{errors:t}=await this.validate(e);this.setErrorsList(t)},getValueByFieldName(e){return o(this.values,e)},hasValueByFieldName(e){return v(this.values,e)},getIsSubmitted(){return this.submitted},async setDefaultData(){if(this.reset(this.defaultValues),this.additionalErrors={},!Object.values(this.defaultErrors).some(t=>t.length))return;this.setErrorsList(this.defaultErrors,V);const{errors:e}=await this.validate();this.setErrorsList(e),this.$nextTick(()=>{this.submitted=!0})},getFieldDefaultValue(e,t){return o(this.innerDefaultValues,e,t)},getErrors(e){return e?this.errors[e]||[]:this.errors},async onSubmit(){this.submitted=!0,this.additionalErrors={};const{values:e,errors:t}=await this.validate();if(this.setErrorsList(t),this.existsErrors)return this.focusInvalidField();this.$emit("submit",e,{setError:this.setError,reset:this.reset,onFieldChange:this.onFieldChange,focusInvalidField:this.focusInvalidField})},async validate(e=null){const{values:t,errors:i}=await this.resolveSchema();return this.fieldComponents.forEach(({resetErrors:s,errors:r,name:d})=>{if(e!==d){const E=r.filter(({resetBehaviour:$})=>$!==F);i[d]=E.concat(i[d]||[])}s()}),{values:t,errors:i}},resolveSchema(){const e=this.values;return this.resolver(e)},onFieldChange(e,t){this.fieldComponentMap[e].onChange(t)},reset(e){this.submitted=!1,e&&(this.innerDefaultValues=JSON.parse(JSON.stringify(e))),this.fieldComponents.forEach(({reset:t})=>{t()})},setErrorsList(e,t=F){Object.entries(e).forEach(([i,s])=>{s.forEach(({message:r,type:d,resetBehaviour:E=t})=>{this.setError(i,{message:r,type:d,resetBehaviour:E})})})},setError(e,{message:t,type:i=null,resetBehaviour:s=V}){const r=this.fieldComponentMap[e];if(r){r.setError({message:t,type:i,resetBehaviour:s});return}this.additionalErrors[e]===void 0&&this.$set(this.additionalErrors,e,[]),this.additionalErrors[e].push({type:i,message:t,resetBehaviour:s})},focusInvalidField(){return this.firstInvalidFieldComponent&&this.firstInvalidFieldComponent.onFocus()},register(e){const t=e.name;return this.fieldComponents.push(e),(this.additionalErrors[t]||[]).forEach(i=>{this.setError(t,i)}),this.$delete(this.additionalErrors,t),()=>this.unregister(e)},unregister(e){this.fieldComponents=this.fieldComponents.filter(t=>t!==e)}},render(e){const t=c(this,{handleSubmit:this.onSubmit,onFieldChange:this.onFieldChange,reset:this.reset,setError:this.setError,focusInvalidField:this.focusInvalidField,values:this.values,dirty:this.dirty,pristine:this.pristine,invalid:this.submitted&&this.existsErrors,errors:this.errors});return t.length<=1?t[0]:e(this.tag,t)}},O={name:"ValidationField",inject:{hasFieldValue:u,getFieldDefaultValue:f,getFieldValue:l,getIsSubmitted:m,register:h,validate:y},data(){return{registered:!1,value:void 0,pristine:!0,errors:[]}},props:{name:{type:String,required:!0},isEqual:{type:Function,default:(e,t)=>e===t},tag:{type:String,default:"div"}},computed:{defaultValue(){return this.getFieldDefaultValue(this.name)},hasProvidedValue(){return this.hasFieldValue(this.name)},providedValue(){return this.getFieldValue(this.name)},submitted(){return this.getIsSubmitted()},dirty(){return!this.isEqual(this.value,this.defaultValue)},firstError(){return this.errors[0]},invalid(){return this.submitted&&!!this.errors.length}},mounted(){this.value=this.hasProvidedValue?this.providedValue:this.defaultValue,this.unregister=this.register(this),this.registered=!0},beforeDestroy(){this.unregister()},methods:{getValue(){return this.value},onFocus(){this.$emit("should-focus",{name:this.name})},reset(){this.resetErrors(),this.$nextTick(()=>{this.onChange(this.defaultValue),this.pristine=!0})},onChange(e){this.isEqual(this.value,e)||(this.value=e,this.pristine=!1,this.$emit("change",e),this.submitted&&this.validate(this.name))},setError({message:e,type:t=null,resetBehaviour:i=V}){this.errors.push({type:t,message:e,resetBehaviour:i})},resetErrors(){this.errors.length&&(this.errors=[])}},render(e){if(!this.registered)return;const t=c(this,{name:this.name,onChange:this.onChange,setError:this.setError,modelValue:this.value,errors:this.errors,firstError:this.firstError,dirty:this.dirty,invalid:this.invalid,pristine:this.pristine});return t.length<=1?t[0]:e(this.tag,t)}},D={name:"ValidationFieldArray",inject:{register:h,getFieldDefaultValue:f,getFieldValue:l},provide(){return{[u]:this.hasValueByFieldName,[l]:this.getValueByFieldName,[h]:this.handleRegister}},data(){return{fields:[],focusOptions:null,errors:[],dirty:!1,pristine:!0}},props:{name:{type:String,required:!0},keyName:{type:String,default:"id"},tag:{type:String,default:"div"}},computed:{defaultValue(){return this.getFieldDefaultValue(this.name)||[]},actualValue(){const e=this.keyName,t=this.getFieldValue(this.name)||[];return this.fields.map((i,s)=>({...t[s],[e]:i[e]}))}},mounted(){this.fields=[...this.defaultValue],this.unregister=this.register(this)},beforeDestroy(){this.unregister()},methods:{hasValueByFieldName(e){const t=`${this.name}.`,i=e.startsWith(t)?e.slice(t.length):e;return v(this.actualValue,i)||v(this.fields,i)},getValueByFieldName(e){const t=`${this.name}.`,i=e.startsWith(t)?e.slice(t.length):e;return o(this.actualValue,i)||o(this.fields,i)},handleRegister(e){if(this.focusOptions){const{focusName:t}=this.focusOptions,{onFocus:i,name:s}=e;s===t&&(i(),this.focusOptions=null)}return this.register(e)},onChange(e){this.fields=[...e]},getValue(){return[]},setErrorActual(){},resetErrors(){},reset(){this.fields=[...this.defaultValue]},append(e,t=null){var i;e[this.keyName]=(i=e[this.keyName])!=null?i:a.nanoid(),this.focusOptions=t,this.fields.push(e)},prepend(e,t=null){var i;e[this.keyName]=(i=e[this.keyName])!=null?i:a.nanoid(),this.focusOptions=t,this.fields.unshift(e)},insert(e,t,i=null){var s;t[this.keyName]=(s=t[this.keyName])!=null?s:a.nanoid(),this.focusOptions=i,this.fields.splice(e,0,t)},swap(e,t){const i=this.fields[e];this.$set(this.fields,e,this.fields[t]),this.$set(this.fields,t,i)},move(e,t){this.fields.splice(t,0,this.fields.splice(e,1)[0])},remove(e){this.fields=this.fields.filter((t,i)=>e!==i)}},render(e){const t=c(this,{name:this.name,fields:this.actualValue,append:this.append,prepend:this.prepend,insert:this.insert,swap:this.swap,move:this.move,remove:this.remove});return t.length<=1?t[0]:e(this.tag,t)}},I={name:"ValidationErrors",inject:{getErrors:p,getIsSubmitted:m},props:{name:{type:String,default:void 0},tag:{type:String,default:"div"}},computed:{submitted(){return this.getIsSubmitted()},errors(){const e=this.getErrors(this.name);return Array.isArray(e)?e:[].concat(...Object.values(e))},invalid(){return this.submitted&&!!this.errors.length}},render(e){if(!this.invalid)return;const t=c(this,{errors:this.errors});return t.length<=1?t[0]:e(this.tag,t)}};n.ValidationErrors=I,n.ValidationField=O,n.ValidationFieldArray=D,n.ValidationProvider=C,n.get=o,n.symbols=b,Object.defineProperties(n,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});
